name: Build iOS IPA (TrollStore)  
  
on:  
  workflow_dispatch:  
    inputs:  
      bundle_id:  
        description: 'Bundle Identifier (e.g., com.yourname.RetroArch)'  
        required: true  
        default: 'com.libretro.RetroArch'  
  
jobs:  
  build-ios:  
    runs-on: macos-latest  
    steps:  
      - name: Checkout RetroArch  
        uses: actions/checkout@v4  
        with:  
          submodules: recursive  
  
      - name: Checkout libretro-super  
        uses: actions/checkout@v4  
        with:  
          repository: libretro/libretro-super  
          path: libretro-super  
  
      - name: Setup Xcode  
        uses: maxim-lobanov/setup-xcode@v1  
        with:  
          xcode-version: latest-stable  
  
      - name: Cache retroarch-apple-deps  
        uses: actions/cache@v3  
        with:  
          path: /usr/local/share/retroarch-apple-deps  
          key: ${{ runner.os }}-retroarch-apple-deps-v1  
  
      - name: Install retroarch-apple-deps  
        run: |  
          if [ ! -d "/usr/local/share/retroarch-apple-deps" ]; then  
            git clone https://github.com/warmenhoven/retroarch-apple-deps.git retroarch-apple-deps  
            sudo ln -s $PWD/retroarch-apple-deps /usr/local/share  
          fi  
  
      - name: Fetch and build cores  
        run: |  
          cd libretro-super  
          ./libretro-fetch.sh --retroarch  
          PLATFORM=ios ./libretro-build-ios-arm64.sh  
          cp -r dist/ios-arm64/*.dylib ../RetroArch/pkg/apple/iOS/modules/  
  
      - name: Configure for TrollStore (no signing)  
        run: |  
          cd pkg/apple  
          sed -i '' "s/com\.libretro\.RetroArch/${{ github.event.inputs.bundle_id }}/g" RetroArch_iOS13.xcodeproj/project.pbxproj  
          # Disable code signing  
          sed -i '' 's/DEVELOPMENT_TEAM = [A-Z0-9]*/DEVELOPMENT_TEAM = ""/g' RetroArch_iOS13.xcodeproj/project.pbxproj  
          sed -i '' 's/CODE_SIGN_IDENTITY = ".*"/CODE_SIGN_IDENTITY = ""/g' RetroArch_iOS13.xcodeproj/project.pbxproj  
            
      - name: Build RetroArch (unsigned)  
        run: |  
          cd pkg/apple  
          xcodebuild -project RetroArch_iOS13.xcodeproj \  
            -scheme "RetroArch iOS Release" \  
            -configuration Release \  
            -destination generic/platform=iOS \  
            -xcconfig iOS/GitLabCI.xcconfig \  
            CODE_SIGNING_ALLOWED=NO \  
            build  
  
      - name: Package IPA for TrollStore  
        run: |  
          cd pkg/apple  
          mkdir -p build/Payload  
          cp -r build/Release-iphoneos/RetroArch.app build/Payload/  
          cd build  
          zip -r RetroArch-TrollStore.ipa Payload/  
            
      - name: Upload IPA  
        uses: actions/upload-artifact@v4  
        with:  
          name: RetroArch-iOS-TrollStore  
          path: pkg/apple/build/RetroArch-TrollStore.ipa
