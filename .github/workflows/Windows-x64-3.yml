name: Build Windows x64 Portable  
  
on:  
  push:  
    branches: [main]  
  workflow_dispatch:  
  
permissions:  
  contents: write  
  
jobs:  
  build:  
    runs-on: ubuntu-latest  
    container:  
      image: git.libretro.com:5050/libretro-infrastructure/libretro-build-mxe-win64-cross:gcc10  
      options: --user root  
        
    steps:  
    - name: Checkout repository  
      uses: taiki-e/checkout-action@v1  
      with:  
        token: ${{ secrets.GITHUB_TOKEN }}  
        persist-credentials: false  
  
    - name: Compile RetroArch  
      run: |  
        export MOC=/usr/lib/mxe/usr/x86_64-w64-mingw32.shared/qt5/bin/moc  
        ./configure --host=x86_64-w64-mingw32.shared  
        make clean  
        make -j$(getconf _NPROCESSORS_ONLN)  
        if [ $STRIP_BIN -eq 1 ]; then strip --strip-unneeded retroarch.exe; fi  
  
    - name: Build and copy filters  
      run: |  
        # Build audio filters  
        cd libretro-common/audio/dsp_filters && make -j$(getconf _NPROCESSORS_ONLN) platform=win compiler=x86_64-w64-mingw32.static-gcc build=release && make -j$(getconf _NPROCESSORS_ONLN) platform=win compiler=x86_64-w64-mingw32.static-gcc build=release strip && cd -  
          
        # Build video filters    
        cd gfx/video_filters && make -j$(getconf _NPROCESSORS_ONLN) platform=win compiler=x86_64-w64-mingw32.static-gcc build=release && make -j$(getconf _NPROCESSORS_ONLN) platform=win compiler=x86_64-w64-mingw32.static-gcc build=release strip && cd -  
  
    - name: Create portable package structure  
      run: |  
        # Create directories  
        mkdir -p retroarch-portable/filters/audio  
        mkdir -p retroarch-portable/filters/video  
        mkdir -p retroarch-portable/pkg  
        mkdir -p retroarch-portable/redist  
          
        # Copy main executable  
        cp retroarch.exe retroarch-portable/  
          
        # Copy filters  
        cp -f libretro-common/audio/dsp_filters/*.dll retroarch-portable/filters/audio/  
        cp -f libretro-common/audio/dsp_filters/*.dsp retroarch-portable/filters/audio/  
        cp -f gfx/video_filters/*.dll retroarch-portable/filters/video/  
        cp -f gfx/video_filters/*.filt retroarch-portable/filters/video/  
          
        # Copy configuration  
        cp -f retroarch.cfg retroarch-portable/pkg/retroarch.default.cfg  
        echo -e '[Paths]\nPlugins = ./' > retroarch-portable/pkg/qt.conf  
  
    - name: Copy DLL dependencies  
      run: |  
        /bin/bash /usr/lib/mxe/tools/copydlldeps.sh \  
            --infile retroarch.exe \  
            --destdir retroarch-portable/redist/ \  
            --recursivesrcdir /usr/lib/mxe/usr/x86_64-w64-mingw32.shared/ \  
            --enforcedir /usr/lib/mxe/usr/x86_64-w64-mingw32.shared/qt5/plugins/bearer/ \  
            --enforcedir /usr/lib/mxe/usr/x86_64-w64-mingw32.shared/qt5/plugins/iconengines/ \  
            --enforcedir /usr/lib/mxe/usr/x86_64-w64-mingw32.shared/qt5/plugins/imageformats/ \  
            --enforcedir /usr/lib/mxe/usr/x86_64-w64-mingw32.shared/qt5/plugins/platforms/ \  
            --enforcedir /usr/lib/mxe/usr/x86_64-w64-mingw32.shared/qt5/plugins/styles/ \  
            --copy \  
            --objdump x86_64-w64-mingw32.shared-objdump  
          
        # Copy NVDA controller for accessibility  
        cp -f nvdaControllerClient64.dll retroarch-portable/redist/ 2>/dev/null || true  
          
        # Remove conflicting OpenGL DLL  
        rm -f retroarch-portable/redist/opengl32.dll
  
    - name: Create archive  
      run: |  
        cd retroarch-portable  
        zip -r ../retroarch-windows-x64-portable.zip .  
  
    - name: Upload artifact  
      uses: actions/upload-artifact@v4  
      with:  
        name: retroarch-windows-x64-portable  
        path: retroarch-windows-x64-portable.zip  
  
    - name: Commit and push binary (optional)  
      if: github.event_name == 'push'  
      run: |  
        git config --local user.email "action@github.com"  
        git config --local user.name "GitHub Action"  
        git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}  
          
        mkdir -p builds/windows-x64  
        cp retroarch.exe builds/windows-x64/  
          
        git add builds/windows-x64/retroarch.exe  
        git commit -m "Auto-update Windows x64 build" || exit 0  
        git push origin HEAD:main
