name: CI Windows x64 (MXE)  
  
on:  
  push:  
  pull_request:  
  repository_dispatch:  
    types: [run_build]  
  
permissions:  
  contents: read  
  
env:  
  ACTIONS_ALLOW_USE_UNSECURE_NODE_VERSION: true  
  
jobs:  
  build:  
    runs-on: ubuntu-latest  
    container:  
      image: git.libretro.com:5050/libretro-infrastructure/libretro-build-mxe-win64-cross:latest  
      options: --user root  
    outputs:  
      sha8: ${{ steps.slug.outputs.sha8 }}  
      cache-key: ${{ steps.cache-key.outputs.key }}  
      
    steps:  
    - uses: taiki-e/checkout-action@v1  
  
    - name: Compile RA  
      run: |
        export MOC=/usr/lib/mxe/usr/x86_64-w64-mingw32.shared/qt5/bin/moc  
        ./configure --host=x86_64-w64-mingw32.shared  
        make clean  
        make -j$(getconf _NPROCESSORS_ONLN)  
  
    - name: Get short SHA  
      id: slug  
      run: echo "sha8=$(echo ${GITHUB_SHA} | cut -c1-8)" >> $GITHUB_OUTPUT  
  
    - name: Generate cache key  
      id: cache-key  
      run: echo "key=retroarch-${{ steps.slug.outputs.sha8 }}-${{ github.run_id }}" >> $GITHUB_OUTPUT  
  
    - name: Cache build artifact  
      uses: actions/cache@v4  
      with:  
        path: retroarch.exe  
        key: ${{ steps.cache-key.outputs.key }}  
  
  upload:  
    needs: build  
    runs-on: ubuntu-latest  
    steps:  
    - uses: actions/checkout@v4  
      
    - name: Restore cached artifact  
      uses: actions/cache@v4  
      with:  
        path: retroarch.exe  
        key: ${{ needs.build.outputs.cache-key }}  
          
    - name: Upload build artifacts  
      uses: actions/upload-artifact@v4  
      with:  
        name: retroarch-x64-${{ needs.build.outputs.sha8 }}  
        path: retroarch.exe